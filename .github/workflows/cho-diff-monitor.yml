name: CHO diff monitor

on:
  workflow_dispatch:
  schedule:
    # Cron is UTC. 08:00 UTC â‰ˆ 09:00 NL zomertijd / 08:00 wintertijd
    - cron: "0 8 * * *"

jobs:
  cho-diff-monitor:
    runs-on: windows-latest

    env:
      TRIPLYDB_TOKEN: ${{ secrets.TRIPLYDB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Download TriplyDB CLI (triplydb.exe)
        shell: pwsh
        run: |
          Invoke-WebRequest `
            -Uri https://static.triply.cc/cli/triplydb.exe `
            -OutFile triplydb.exe

      - name: Bepaal datums
        shell: pwsh
        run: |
          $vandaag = (Get-Date).ToString("yyyy-MM-dd")
          $gisteren = (Get-Date).AddDays(-1).ToString("yyyy-MM-dd")          $eer_gisteren = (Get-Date).AddDays(-2).ToString("yyyy-MM-dd")
          echo "VANDAAG=$vandaag" >> $env:GITHUB_ENV
          echo "GISTEREN=$gisteren" >> $env:GITHUB_ENV


      - name: Run CHO diff monitor
        shell: pwsh
        env:
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python scripts/compare.py `
            "$env:VANDAAG" `
            "$env:GISTEREN" `
            "https://linkeddata.cultureelerfgoed.nl/graph/cho-diff/$env:VANDAAG" `
            "https://linkeddata.cultureelerfgoed.nl/graph/cho-diff/$env:GISTEREN"

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: cho-diff-csv-${{ env.VANDAAG }}_${{ env.GISTEREN }}
          path: diff-cho-*.csv